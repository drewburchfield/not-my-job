#!/bin/bash

echo "üîç Running pre-commit checks..."

# Check for secrets in staged files
if git diff --cached --name-only | xargs grep -E '(AKIA[0-9A-Z]{16}|ghp_[0-9a-zA-Z]{36}|github_pat_[0-9a-zA-Z]{82}|glpat-[0-9a-zA-Z_\-]{20}|sk-[0-9a-zA-Z]{48}|SG\.[0-9a-zA-Z_\-]{22}\.[0-9a-zA-Z_\-]{43}|eyJ[0-9a-zA-Z_\-]+\.eyJ[0-9a-zA-Z_\-]+\.)' 2>/dev/null; then
    echo ""
    echo "‚ùå BLOCKED: Possible API key or token detected in staged files!"
    echo "   Review the output above and remove secrets before committing."
    exit 1
fi

# Check for .env files
if git diff --cached --name-only | grep -E '\.env$|\.env\.local$' 2>/dev/null; then
    echo ""
    echo "‚ö†Ô∏è  WARNING: .env file is staged for commit!"
    echo "   .env files should NOT be committed to git."
    read -p "Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚ùå Commit cancelled."
        exit 1
    fi
fi

# Run npm audit if package.json or package-lock.json changed
if git diff --cached --name-only | grep -E 'package\.json|package-lock\.json' 2>/dev/null; then
    if [ -f package.json ]; then
        echo "üì¶ Auditing dependencies for vulnerabilities..."
        npm audit --audit-level=high
        if [ $? -ne 0 ]; then
            echo ""
            echo "‚ö†Ô∏è  WARNING: High or critical vulnerabilities detected!"
            read -p "Commit anyway? (y/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo "‚ùå Commit cancelled. Run: npm audit fix"
                exit 1
            fi
        fi
    fi
fi

# Check plugin.json versions match marketplace.json
MARKETPLACE=".claude-plugin/marketplace.json"
if [ -f "$MARKETPLACE" ]; then
    MISMATCH=""
    for plugin_json in plugins/*/.claude-plugin/plugin.json; do
        [ -f "$plugin_json" ] || continue
        name=$(python3 -c "import json; print(json.load(open('$plugin_json'))['name'])" 2>/dev/null)
        pver=$(python3 -c "import json; print(json.load(open('$plugin_json'))['version'])" 2>/dev/null)
        mver=$(python3 -c "
import json
d = json.load(open('$MARKETPLACE'))
for p in d['plugins']:
    if p['name'] == '$name':
        print(p['version'])
        break
else:
    print('MISSING')
" 2>/dev/null)
        if [ -n "$pver" ] && [ -n "$mver" ] && [ "$pver" != "$mver" ]; then
            MISMATCH="${MISMATCH}\n   $name: plugin.json=$pver  marketplace.json=$mver"
        fi
    done
    if [ -n "$MISMATCH" ]; then
        echo ""
        echo "‚ùå BLOCKED: Plugin version mismatch between plugin.json and marketplace.json!"
        echo -e "$MISMATCH"
        echo ""
        echo "   Update both files to use the same version before committing."
        exit 1
    fi
fi

echo "‚úÖ Pre-commit checks passed"
